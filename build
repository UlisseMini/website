#!/bin/sh
# This script builds all files needed for the site into ./bin
set -e

# Can be release or debug
profile="$1"
if [ "$profile" != "profile" ] && [ "$profile" != "debug" ]; then
	echo "profile must be release or debug, got $profile"
	exit 1
fi

elm_cmd="elm make src/Main.elm"
if [ "$profile" = "release" ]; then
	elm_cmd="$elm_cmd --optimize"
fi

# Reset ./bin
rm -rf bin && mkdir -p bin/public

# Build the frontend
cd elm
for dir in *; do
	cd "$dir"
	$elm_cmd --output "../../bin/public/$dir.js"
	cd ..
done
cd ..

# Copy and minify static files
cp -rv public/* bin/public
minify -srv bin/public -o bin/public

# Build the backend
if [ "$profile" = "release" ]; then
	cargo build "--$profile"
	cp -v target/"$profile"/website bin
else
	cargo build
	cp -v target/debug/website bin
fi
